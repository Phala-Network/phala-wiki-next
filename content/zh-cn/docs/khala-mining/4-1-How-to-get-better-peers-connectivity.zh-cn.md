---
title: "4.1 如何提高和P2P节点的连接性"
---

## 面临的问题

一些朋友在运行节点的时候发现他们的节点很难连接到其他的节点，比如日志中


```javascript
[Relaychain] 💤 Idle (3 peers), best: #8949573 (0x1fbd…efce), finalized #8949248 (0x102e…0032), ⬇ 1.1kiB/s ⬆ 1.0kiB/s
```


这里 `3 peers` 意思是只连接到三个外部的节点，这种情况会遇到诸如节点卡住了不继续同步，甚至是报错的问题，遇到这些问题通常可以重启节点来解决，但是会影响到挖矿。


这种情况可以检查网络是不是这篇技术文章你可以知道怎么做以及为什么。

## 太长不读

问运营商要公网IP，把自己路由器配个DMZ或者配个端口映射，把没必要的NAT关了。

## 原理解释：状态防火墙

随着IPv4的耗尽，一些安全考量以及一些设计上的问题，你的节点到伙伴节点的链接之间可能存在着很多状态防火墙。这些状态防火墙运行着NAT（网络地址转换），过滤策略或者别的一些东西。这增加了建立连接的复杂性，也造成了很多问题。

### 防火墙做了什么

#### 对来源地址的转换（Source NAT）

对来源地址的转换使得很多设备可以用同一个公网地址。这是依靠防火墙跟踪和记录每个主机向外建立的连接来实现的。所有发往防火墙外面的数据包的来源地址都被改成了防火墙的地址。这样当远程主机回复数据包的时候就会发给防火墙。防火墙知道谁才是真正的目的来数据包送出去。


但如果一些防火墙外面的远程主机想要向防火墙里面的主机建立连接，就没有办法了。数据包到达防火墙，防火墙去查它维护的连接的列表，大多数时候什么都查不到。所以防火墙就把数据包丢了。

防火墙可能用不同的信息和办法来维护连接的状态，这会造成不同的结果。你可以看看 [https://zh.wikipedia.org/wiki/网络地址转换#不同類型的-{NAT}-](https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2#%E4%B8%8D%E5%90%8C%E9%A1%9E%E5%9E%8B%E7%9A%84-%7BNAT%7D-) 来知道怎么回事。

请注意，网络地址转换不一定只是你的网络设备运行的，你的运营商可能也在这样做；不止是名叫防火墙的设备有能力这么做，几乎所有家用的“路由器”盒子都隐含了这样的功能。你可能已经处在很多层地址转换后面。

### 过滤策略

很多网络提供商和托管提供商会用一些过滤策略来丢你发出或者发给你的包。这是为了安全或者是防止滥用，因为P2P连接经常被用来传播不法内容。这可能直接丢掉你和伙伴的链接。

## 怎么办

### 避免麻烦

你应该先咨询你的网络提供商是不是在给你执行来源地址转换或者过滤策略。如果是的话，和他们谈谈让他们不要这么办。

### 配置设备来让连接性好一点

如果你环境所限一定得跑来源地址转换，你还可以改改你的设备配置来让连接性好一点。

#### 目的地址转换（Destination NAT），暴露特定主机以及UPnP

你可以配置目的地址转换来暴露你的节点正在监听的端口；一些家用设备可能可以配置DMZ主机来收所有发进来的没被追踪到连接的包。

有一些家用设备可以设置一下监听UPnP来自动设置目的地址转换，但通常不稳定，所以一般不要考虑。
